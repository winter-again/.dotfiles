#!/usr/bin/env bash

source ~/.owm
# UNITS="imperial"
UNITS="metric"
# TEMP_SYMBOL="F"
TEMP_SYMBOL="C"
# WIND_THRESH=25 # mph
WIND_THRESH=12 # m/s
# WIND_SYMBOL="mph"
WIND_SYMBOL="m/s"

# current weather data API
# url="https://api.openweathermap.org/data/2.5/weather?appid=${API_KEY}&units=${UNITS}&lang=en&q=$(echo $CITY | sed 's/ /%20/g'),${COUNTRY}"
url="https://api.openweathermap.org/data/2.5/weather?appid=${API_KEY}&id=${CITY_ID}&units=${UNITS}&lang=en"
resp=$(curl -s "$url")
desc=$(echo "$resp" | jaq .weather[0].description | tr -d '"')
feels_like=$(echo "$resp" | jaq .main.feels_like)
wind=$(echo "$resp" | jaq .wind.speed)

if [[ "$wind" -ge "$WIND_THRESH" ]]; then
    output="$desc | $feels_like$TEMP_SYMBOL |  $wind $WIND_SYMBOL"
else
    output="$desc | $feels_like$TEMP_SYMBOL"
fi

printf '{"text": "%s", "class": "custom-weather"}' "$output"
