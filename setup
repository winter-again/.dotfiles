#!/usr/bin/env bash

# NOTE: run as newly created user

set -uxo pipefail

pacman_install() {
    sudo pacman -S --needed --noconfirm "$@"
}

paru_install() {
    paru -S --needed --noconfirm "$@"
}

BUILD_REPOS="$HOME/build-repos"
PARU_REPO="$BUILD_REPOS/paru"

read -r -p "Confirm ready to setup system for user $USER with home $HOME (y/n): " confirm && [[ $confirm = [yY] ]] || exit 1
echo

cd "$HOME" || exit 1

echo "Checking internet connection..."
ping -c 3 archlinux.org || { echo "Not connected to internet" && exit 1; }

echo "Configuring /etc/pacman.conf..."
sudo sed -i "/Color/s/^#//g" /etc/pacman.conf
sudo sed -i "/VerbosePkgLists/s/^#//g" /etc/pacman.conf
sudo sed -i "/CheckSpace/s/^#//g" /etc/pacman.conf # should already be default

echo "Updating before proceeding..."
sudo pacman -Syu --noconfirm

echo "Installing and configuring reflector. Activating reflector.timer..."
pacman_install reflector
sudo tee /etc/xdg/reflector/reflector.conf >/dev/null <<"EOF"
--protocol https
--country US,CA
--latest 10
--sort rate
--save /etc/pacman.d/mirrorlist
EOF
sudo systemctl enable --now reflector.timer

echo "Installing pacman-contrib and activating paccache.timer..."
pacman_install pacman-contrib
sudo systemctl enable --now paccache.timer

echo "Setting up xdg-user-dirs and installing xdg-utils..."
pacman_install xdg-user-dirs xdg-utils
xdg-user-dirs-update

echo "Installing paru..."
if ! type paru >/dev/null; then
    pacman_install rustup
    rustup default stable
    mkdir "$BUILD_REPOS"
    git clone https://aur.archlinux.org/paru.git "$PARU_REPO"
    cd "$PARU_REPO" || exit 1
    makepkg -sirc --noconfirm
    cd "$HOME" || exit 1
else
    echo "paru already installed..."
fi

echo "Installing Intel graphics packages..."
intel_graphics_pkgs=(
    mesa
    mesa-utils
    intel-media-driver
    libva-utils
)
paru_install "${intel_graphics_pkgs[@]}"

echo "Installing Pipewire and other sound packages..."
sound_pkgs=(
    pipewire
    pipewire-audio
    pipewire-alsa
    pipewire-pulse
    pipewire-jack
    wireplumber
    pavucontrol
)
# NOTE: will be prompted to replace jack2 with pipewire-jack, so respond with "y" since
# default is "N"
# NOTE: can't use --no-confirm for this
# paru -S --needed "${sound_pkgs[@]}"
printf "%s\n" y Y | paru -S --needed "${sound_pkgs[@]}"

echo "Blacklisting bluetooth and btusb modules..."
sudo tee /etc/modprobe.d/blacklist.conf >/dev/null <<"EOF"
blacklist bluetooth
blacklist btusb
EOF
echo "Regenerating mkinitcpio..."
mkinitcpio -P

echo "Installing Sway and other core packages..."
sway_pkgs=(
    sway
    swayidle
    swaybg
    brightnessctl
    ghostty
    grim
    gtklock
    kanshi
    mako
    slurp
    solaar
    swappy
    waybar
    wl-clipboard
)
paru_install "${sway_pkgs[@]}"

echo "Installing fonts..."
font_pkgs=(
    ttf-zed-mono-nerd
    ttf-iosevka-nerd
    ttf-nerd-fonts-symbols-mono
    noto-fonts
    noto-fonts-cjk
    noto-fonts-emoji
)
paru_install "${font_pkgs[@]}"

echo "Installing zsh packages..."
zsh_pkgs=(
    zsh
    zsh-autosuggestions
    zsh-completions
    zsh-syntax-highlighting
)
paru_install "${zsh_pkgs[@]}"

echo "Installing core tools..."
tools=(
    bat
    bottom
    dust
    dysk
    eza
    fd
    fzf
    git-lfs
    jaq
    just
    openssh
    poppler
    ripgrep
    stow
    task
    tmux
    unzip
    usbutils
    wget
    xan
    yazi
    yt-dlp
    zip
    zoxide
)
paru_install "${tools[@]}"

echo "Running Git LFS install command..."
git lfs install

echo "Installing Lua packages..."
lua_dev_pkgs=(
    lua-language-server
    selene
    stylua
)
paru_install "${lua_dev_pkgs[@]}"

echo "Installing Python packages..."
python_dev_pkgs=(
    ruff
    uv
)
paru_install "${python_dev_pkgs[@]}"
echo "Installing uv tools..."
# NOTE: not sure if --managed-python is needed, but doesn't hurt
uv python --managed-python install # installs latest Python
uv_tools=(
    basedpyright
    sqruff
)
uv tool install "${uv_tools[@]}"

echo "Installing Go packages..."
go_dev_pkgs=(
    go
    go-tools
    gopls
)
paru_install "${go_dev_pkgs[@]}"

echo "Installing Typst packages..."
# NOTE: websocat is for typst-preview nvim plugin
typst_dev_pkgs=(
    typst
    tinymist
    websocat
)
paru_install "${typst_dev_pkgs[@]}"

echo "Installing JS/TS packages..."
js_dev_pkgs=(
    pnpm
    typescript-language-server
    vscode-html-languageserver
    vscode-css-languageserver
    vscode-json-languageserver
)
paru_install "${js_dev_pkgs[@]}"
echo "Installing Astro LSP as global package via pnpm..."
# NOTE: seems that this fails if given path isn't in PATH
# so I set PATH like this and it works, even if path doesn't exist
# Seems that setting PNPM_HOME is needed as well. Though it should resolve to that path by default
export PNPM_HOME="$HOME/.local/share/pnpm"
PATH="$PATH:$PNPM_HOME"
pnpm add -g @astrojs/language-server

echo "Installing Rust packages..."
rust_dev_pkgs=(
    rust-analyzer
)
paru_install "${rust_dev_pkgs[@]}"

echo "Installing other dev packages..."
dev_pkgs=(
    clang
    bash-language-server
    markdownlint-cli2
    marksman
    shellcheck
    shfmt
    taplo-cli
    yaml-language-server
)
paru_install "${dev_pkgs[@]}"

echo "Building and installing Neovim from source..."
nvim_pkgs=(
    base-devel
    cmake
    curl
    ninja
    tree-sitter-cli
    unzip
)
paru_install "${nvim_pkgs[@]}"
if ! type nvim >/dev/null; then
    git clone https://github.com/neovim/neovim.git "$BUILD_REPOS/neovim"
    cd "$BUILD_REPOS/neovim" || exit 1
    git remote set-url origin git@github.com:neovim/neovim.git
    git remote set-url --push origin git@github.com:neovim/neovim.git
    git checkout nightly
    make CMAKE_BUILD_TYPE=RelWithDebInfo
    sudo make install
    cd "$HOME" || exit 1
else
    echo "Neovim already installed..."
fi

echo "Mapping caps lock to escape and control..."
paru_install keyd
sudo tee /etc/keyd/default.conf >/dev/null <<"EOF"
[ids]

*

[main]

capslock = overload(control, esc)
EOF
sudo systemctl enable --now keyd.service

echo "Cloning dotfiles and stowing dotfiles..."
if [[ ! -d "$HOME/.dotfiles" ]]; then
    git clone https://github.com/winter-again/.dotfiles.git "$HOME/.dotfiles"
    cd "$HOME/.dotfiles" || exit 1
    git remote set-url origin git@github.com:winter-again/.dotfiles.git
    git remote set-url --push origin git@github.com:winter-again/.dotfiles.git
    just
    cd "$HOME" || exit 1
fi

echo "Installing Materia theme packages for GTK and Qt. Must still set theme manually..."
theme_pkgs=(
    kvantum
    kvantum-qt5
    kvantum-theme-materia
    materia-gtk-theme
    nwg-look
)
paru_install "${theme_pkgs[@]}"

echo "Installing XDG desktop portals..."
xdg_portal_pkgs=(
    xdg-desktop-portal
    xdg-desktop-portal-wlr
    xdg-desktop-portal-gtk
)
paru_install "${xdg_portal_pkgs[@]}"

echo "Installing other apps..."
app_pkgs=(
    amberol
    chromaprint
    gst-libav
    imv
    libreoffice-still
    mpv
    nemo
    picard
    qt5-wayland
    spotify-launcher
)
paru_install "${app_pkgs[@]}"
# imv
xdg-mime default imv-dir.desktop image/png image/jpeg
# nemo
xdg-mime default nemo.desktop inode/directory application/x-gnome-saved-search
gsettings set org.cinnamon.desktop.default-applications.terminal exec wezterm

echo "Installing zathura..."
zathura_pkgs=(
    zathura
    zathura-pdf-mupdf
)
# NOTE: select 30 for tesseract eng pkg
printf "%s\n" 30 Y | paru -S --needed "${zathura_pkgs[@]}"
# paru -S --needed "${zathura_pkgs[@]}"
# NOTE: uses custom stowed desktop file
xdg-mime default org.pwmt.zathura-sandbox.desktop application/pdf

echo "Installing all AUR packages..."
aur_pkgs=(
    epson-inkjet-printer-escpr2
    librewolf-bin
    oh-my-posh-bin
    slack-desktop
    tofi
    wezterm-git
)
# NOTE: will require manual responses and PKGBUILD review
paru -S --needed "${aur_pkgs[@]}"
# paru_install "${aur_pkgs[@]}"

echo "Installing Wezterm terminfo..."
tempfile=$(mktemp) &&
    curl -o "$tempfile" https://raw.githubusercontent.com/wezterm/wezterm/main/termwiz/data/wezterm.terminfo &&
    tic -x -o ~/.terminfo "$tempfile" &&
    rm "$tempfile"

echo "Installing flow..."
go install github.com/winter-again/flow@latest

echo "Installing system maintenance packages..."
sys_maint_pkgs=(
    libsmbios
    nvme-cli
    smartmontools
    thermald
    trash-cli
    util-linux
)
paru_install "${sys_maint_pkgs[@]}"
echo "Enabling and starting thermald.service..."
sudo systemctl enable --now thermald.service

echo "Enabling and starting fstrim.timer..."
sudo systemctl enable --now fstrim.timer

echo "Increasing allowed failed login attempts from 3 to 5..."
sudo sed -i "s/.*deny = .*/deny = 5/" /etc/security/faillock.conf

echo "Installing rclone, restic, and rsync for backups..."
paru_install rclone restic rsync

echo "Installing networking-related packages..."
network_pkgs=(
    bind
    gnome-keyring
    libsecret
    tcpdump
)
paru_install "${network_pkgs[@]}"

echo "Disabling NetworkManager connectivity check..."
sudo tee /etc/NetworkManager/conf.d/20-connectivity.conf >/dev/null <<"EOF"
[connectivity]
enabled=false
EOF

echo "Creating NetworkManager dispatcher for setting timezone..."
sudo tee /etc/NetworkManager/dispatcher.d/09-timezone >/dev/null <<"EOF"
#!/bin/sh

case "$2" in
    up)
        timedatectl set-timezone "$(curl --fail https://ipapi.co/timezone)"
    ;;
esac
EOF
sudo chmod +x /etc/NetworkManager/dispatcher.d/09-timezone
sudo chown root:root /etc/NetworkManager/dispatcher.d/09-timezone
sudo systemctl enable --now NetworkManager-dispatcher.service
sudo systemctl restart NetworkManager.service

echo "Installing powertop and tlp..."
power_pkgs=(
    powertop
    tlp
    tlp-rdw
)
paru_install "${power_pkgs[@]}"
sudo systemctl enable --now tlp.service
sudo systemctl mask --now systemd-rfkill.service
sudo systemctl mask --now systemd-rfkill.socket
# NOTE: blacklisting bluetooth modules instead
# sudo sed -i 's/.*DEVICES_TO_DISABLE_ON_STARTUP=.*/DEVICES_TO_DISABLE_ON_STARTUP="bluetooth"/' /etc/tlp.conf
sudo sed -i 's/.*DEVICES_TO_DISABLE_ON_LAN_CONNECT=.*/DEVICES_TO_DISABLE_ON_LAN_CONNECT="wifi"/' /etc/tlp.conf
sudo sed -i 's/.*DEVICES_TO_ENABLE_ON_LAN_DISCONNECT=.*/DEVICES_TO_ENABLE_ON_LAN_DISCONNECT="wifi"/' /etc/tlp.conf

echo "Disabling lid switch..."
sudo sed -i "s/.*HandleLidSwitch=.*/HandleLidSwitch=ignore/" /etc/systemd/logind.conf
sudo sed -i "s/.*HandleLidSwitchExternalPower=.*/HandleLidSwitchExternalPower=ignore/" /etc/systemd/logind.conf
sudo sed -i "s/.*HandleLidSwitchDocked=.*/HandleLidSwitchDocked=ignore/" /etc/systemd/logind.conf
sudo tee /etc/systemd/system/ignore-lid-wakeup.service >/dev/null <<"EOF"
[Unit]
Description="Disable LID0 wake from suspend trigger"

[Service]
ExecStart=/bin/sh -c "/bin/echo LID0 > /proc/acpi/wakeup"

[Install]
WantedBy=multi-user.target
EOF

echo "Installing CUPS..."
cups_pkgs=(
    cups
    cups-pdf
)
paru_install "${cups_pkgs[@]}"
sudo systemctl enable --now cups.socket

echo "Installing ufw and activating firewall..."
paru_install ufw
sudo systemctl enable --now ufw.service
sudo ufw enable

# echo "Configuring SSH key for GitHub..."
# # NOTE: will prompt for password
# ssh-keygen -f "$HOME/.ssh/github" -C "$(whoami)@$(uname -n)"
# cat > "$HOME/.ssh/config" <<"EOF"
# Host github.com
#     HostName github.com
#     IdentitiesOnly yes
#     IdentityFile ~/.ssh/github
#     PreferredAuthentications publickey
# EOF

echo
echo "Done. Reboot the system..."
